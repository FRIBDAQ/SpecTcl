#### Start of system configuration section. ####

VERSION = 2.10.1
srcdir = .
DESTDIR=
INSTALL = @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_DATA = @INSTALL_DATA@
LIBS = @LIBS@
EXTRA_OBJS = @EXTRA_OBJS@
EXTRA_LIBS = @EXTRA_LIBS@
# ************************************************************
# *  If you have the 'electric fence' library installed, you *
# *  can debug memory faults and other problems by adding    *
# *           -lefence                                       *
# *  at the end of the LIBS line above                       *
# ************************************************************

DEFS = -DVERSION=\"$(VERSION)\" -DDEFAULT_GRI_DIR=\"$(libdir)\" $(HAVE_LINUX) @DEFS@
CFLAGS = @CFLAGS@
CPPFLAGS = @CPPFLAGS@
CXXFLAGS = -g @CXXFLAGS@
EXTRA_CFLAGS = @EXTRA_CFLAGS@ $(LINUX_EXTRA_CFLAGS)
EXTRA_CFLAGS_TEMPLATE = @EXTRA_CFLAGS_TEMPLATE@ $(LINUX_EXTRA_CFLAGS)
prefix = @prefix@
bindir = $(prefix)/bin
libdir = $(prefix)/share/gri/$(VERSION)
#### End of system configuration section. ####

OBJS = G_string.o GriColor.o GriPath.o GriState.o assert.o chopword.o \
close.o command.o convert.o debug.o delete.o differ.o doline.o draw.o \
endup.o expect.o file.o filter.o flip.o gr.o gr_coll.o graxes.o \
grcntour.o gri.o grimage.o grinterp.o grsmooth.o grstring.o group.o heal.o \
help.o if.o ignore.o image.o input.o insert.o interp.o mask.o math.o \
new.o open.o popen.o query.o quit.o read.o regress.o reorder.o \
rescale.o rewind.o rpn.o rpncalc.o scales.o set.o show.o skip.o \
sleep.o smooth.o source.o startup.o state.o stats.o storage.o \
synonyms.o template.o timer.o unlink.o utility.o variable.o version.o \
while.o write.o

gri: $(OBJS) $(EXTRA_OBJS)
	$(CXX) -o gri $(LDFLAGS) $(OBJS) $(EXTRA_OBJS) $(LIBS) $(EXTRA_LIBS)

# Next is a kludge.  Trying to get a local popt working, 
# e.g. for solaris.  Based on popt-1.2
popt/findme.o: popt/findme.c
	cd popt ; $(CC) $(DEFS) -c findme.c
popt/popt.o: popt/popt.c
	cd popt ; $(CC) $(DEFS) -c popt.c
popt/poptconfig.o: popt/poptconfig.c
	cd popt ; $(CC) $(DEFS) -c poptconfig.c
popt/popthelp.o: popt/popthelp.c
	cd popt ; $(CC) $(DEFS) -c popthelp.c
popt/poptparse.o: popt/poptparse.c
	cd popt ; $(CC) $(DEFS) -c poptparse.c

# Here are a few explicit rules used by the author for debugging;
# it is emphaticallyy *not* a complete list.  It is only as
# up-to-date as the last time the author was working on the
# pertinent parts of the code.
#
# If you edit the ANY .cc source files,
#	make
# will work as you expect.  However, if you edit any .hh
# source files, you should do
#	make clean
#       make
# to ensure that everything is brought up-to-date.
close.o: DataFile.hh
file.o: DataFile.hh
read.o: DataFile.hh
rewind.o: DataFile.hh
show.o: DataFile.hh
skip.o: DataFile.hh

GriColor.o:     GriColor.hh
GriState.o:     GriState.hh
gr.o:           GriState.hh
gri.o:		GriState.hh
set.o:          GriState.hh
state.o:        GriState.hh
template.o:     GriState.hh
command.o:	tags.hh
variable.o:     Variable.hh
synonyms.o:     Synonym.hh
convert.o:	GMatrix.hh
grcntour.o: 	GMatrix.hh
gri.o: 		GMatrix.hh
grsmooth.o: 	GMatrix.hh
smooth.o: 	GMatrix.hh
G_string.o:     G_string.hh

CXX = @CXX@

# Special rule for templates, so as not to use
# -fno-implicit-templates (g++ weirdness).  This special
# case depends on whether -frepo exists ... and whether the installer
# has temerity to try it!
template.o: template.cc
	$(CXX) -c $(CXXFLAGS) $(EXTRA_CFLAGS_TEMPLATE) $(DEFS) -I$(srcdir) $<



.SUFFIXES: .cc
.cc.o:
	$(CXX) -c $(CXXFLAGS) $(EXTRA_CFLAGS) $(CPPFLAGS) $(DEFS) -I$(srcdir) $<


# Handle startup in special way since it needs version number.
startup.o: version.cc startup.cc Makefile.in
	$(CXX) -c $(CXXFLAGS) $(EXTRA_CFLAGS) $(CPPFLAGS) $(DEFS) -I$(srcdir) startup.cc

# Install all relevant files, creating directories, destroying old
# links and creating new links as necessary.
install: all install-bin
	@echo "Installing into '$(prefix)' directory"
	cd doc; prefix=$(prefix) make install INSTALL='$(INSTALL)' 

install-bin:
	cat startup.msg | sed -e s,VSN,${VERSION}, -e s,PREFIX,$(prefix), > tmp
	$(INSTALL_PROGRAM) -d $(libdir)
	$(INSTALL_DATA) tmp $(libdir)/startup.msg
	rm -f tmp
	$(INSTALL_DATA)         gri.cmd         $(libdir)/gri.cmd
	$(INSTALL_DATA)         logo.dat        $(libdir)/logo.dat
	$(INSTALL_DATA)         license.txt     $(libdir)/license.txt
	$(INSTALL_PROGRAM) -d                   $(prefix)/bin
	$(INSTALL_PROGRAM)      gri             $(prefix)/bin/gri-$(VERSION)
	(cd $(prefix)/bin/ ; rm -f gri ; ln -sf gri-$(VERSION) gri)
	$(INSTALL_PROGRAM)      gri_merge       $(prefix)/bin/gri_merge
	$(INSTALL_PROGRAM)      gri_unpage      $(prefix)/bin/gri_unpage

debian-lib = $(debian)/usr/share/gri/$(VERSION)
install_linux_debian: gri
	@echo "Installing into '$(debian)' directory"
	install -d $(debian-lib)
	if test -f startup.debian; then sed -e s,VSN,${VERSION}, startup.debian > $(debian-lib)/startup.msg; else echo "WARNING: no startup.debian file!"; fi;
	install -d         $(debian)/usr/bin
	install -m 755 gri $(debian)/usr/bin/gri-$(VERSION)
	(cd $(debian)/usr/bin; ln -fs gri-$(VERSION) gri)
	install -m 644 gri.cmd  $(debian-lib)/gri.cmd
	install -m 644 logo.dat $(debian-lib)/logo.dat
	if test -f gri_merge; then install -m 755 gri_merge $(debian)/usr/bin; else echo "WARNING: no gri_merge file!"; fi;	
	if test -f gri_unpage; then install -m 755 gri_unpage $(debian)/usr/bin; else echo "WARNING: no gri_unpage file!";fi;
	install -d $(debian)/usr/share/emacs/site-lisp
	install -m 644 gri-mode.el $(debian)/usr/share/emacs/site-lisp/

install_linux_debian_grionly: gri
	@echo "Installing into '$(debian)' directory"
	install -d             $(debian-lib)
	install -m 644 gri.cmd  $(debian-lib)/gri.cmd
	install -m 644 logo.dat $(debian-lib)/logo.dat
	if test -f startup.debian; then sed -e s,VSN,${VERSION}, startup.debian > $(debian-lib)/startup.msg; else echo "WARNING: no startup.debian file!"; fi;
	install -d         $(debian)/usr/bin
	install -m 755 gri $(debian)/usr/bin/gri-$(VERSION)

install_linux_redhat:
#	Create the needed dirs in the BuildRoot (this is what $(DESTDIR) is being
#	used for)
	mkdir -m 755 -p $(DESTDIR)$(prefix)/share/gri
	mkdir -m 755 -p $(DESTDIR)$(prefix)/share/emacs/site-lisp
	mkdir -m 755 -p $(DESTDIR)$(prefix)/bin
	mkdir -m 755 -p $(DESTDIR)$(prefix)/share/man/man1
	mkdir -m 755 -p $(DESTDIR)$(prefix)/share/info

	if test -f startup.redhat; then cat startup.redhat | sed -e s,VSN,${VERSION}, > tmp; $(INSTALL_DATA) tmp $(DESTDIR)$(prefix)/share/gri/startup.msg; rm -f tmp; else echo "WARNING: no startup.redhat file!"; fi;

	/usr/bin/install -m 755  gri                           $(DESTDIR)$(prefix)/bin/gri
	/usr/bin/install -m 755  gri_merge                     $(DESTDIR)$(prefix)/bin/gri_merge
	/usr/bin/install -m 755  gri_unpage                    $(DESTDIR)$(prefix)/bin/gri_unpage
	/usr/bin/install -m 644  gri.cmd                       $(DESTDIR)$(prefix)/share/gri/gri.cmd
	/usr/bin/install -m 644  logo.dat                      $(DESTDIR)$(prefix)/share/gri/logo.dat
	/usr/bin/install -m 644  license.txt                   $(DESTDIR)$(prefix)/share/gri/license.txt
#
#	gri mode (tweaked a bit for redhat since debian goes to web to see manual)
	sed -e "s,WWW-page \"http://gri.sourceforge.net/gridoc/html/index.html\",WWW-page \"file:$(prefix)/doc/gri-$(VERSION)/html/index.html\",;s,gri\*directory-tree \"/usr/local/share/gri\",gri*directory-tree \"/usr/share/gri\"," gri-mode.el > tmp
	/usr/bin/install -m 644  tmp                           $(DESTDIR)$(prefix)/share/emacs/site-lisp/gri-mode.el
	-rm -f tmp
	cat doc/gri-manpage-redhat.1 | sed -e s,VERSION,${VERSION}, > tmp
	/usr/bin/install -m 644  tmp                           $(DESTDIR)$(prefix)/share/man/man1/gri.1
	rm -f tmp
	/usr/bin/install -m 644  doc/gri_merge.1               $(DESTDIR)$(prefix)/share/man/man1/gri_merge.1
	/usr/bin/install -m 644  doc/gri_unpage.1              $(DESTDIR)$(prefix)/share/man/man1/gri_unpage.1
	-rm -f $(DESTDIR)$(prefix)/share/info/gri.info*
	/usr/bin/install -m 644  doc/gri.info*                 $(DESTDIR)$(prefix)/share/info
	cd $(DESTDIR)$(prefix)/share/info ; gzip -f --best gri.info*


all: force
	make gri
	make doc

force:

doc: force
	cd doc; make info html

TAGS:
	etags *.cc *.hh
tags:
	etags *.cc *.hh
etags:
	etags *.cc *.hh

clean:
	-rm -f config.cache config.log config.status
	-rm -f gri *.o *.rpo core *.bak *.BAK *~ \#* tmp
#	Clean template-function directory, if existent. (Created by
#	IBM C++ compiler.)
	-rm -rf tempinc


distclean:
	make clean
	cd doc ; make clean
	rm -f Makefile

# Source distribution
        SOURCE_NAME = gri-$(VERSION)
           DEST_DIR = .
source-copy:
#	Clean directory, if existent.
	-rm -rf $(SOURCE_NAME)
	install -d $(SOURCE_NAME)
	install -d $(SOURCE_NAME)/popt
#	Copy source
	install -m 644 ChangeLog *.cc *.hh gri.cmd logo.dat license.txt \
	    Makefile.in Makefile.dj2 configure configure.in install-sh \
	    check.pl \
	    copyright.txt AUTHOR README* gri-mode.el gri_merge gri_unpage \
	    startup.msg startup.debian startup.redhat gri*.spec grilogo.gif \
	    install-SunOS5 README-SunOS5 \
	        $(SOURCE_NAME)
	(cd popt ; \
	    install -m 644 popt.h findme.h poptint.h \
	                   ../$(SOURCE_NAME)/popt )
	(cd popt ; \
	    install -m 644 popt.c findme.c poptparse.c poptconfig.c popthelp.c \
	                   ../$(SOURCE_NAME)/popt )
	install -m 755 configure install-sh $(SOURCE_NAME)
	install -d $(SOURCE_NAME)/debian
	(cd debian; install -m 644 0* READ* c* gri* ../$(SOURCE_NAME)/debian)
	install -m 755 debian/rules                    $(SOURCE_NAME)/debian
#	Copy documentation
	install -d $(SOURCE_NAME)/doc
	install -m 755 doc/install-sh           $(SOURCE_NAME)/doc
	install -m 755 doc/archive-to-html.pl   $(SOURCE_NAME)/doc
	install -m 755 doc/texim2texi           $(SOURCE_NAME)/doc
	install -m 755 doc/texinfo2HTML         $(SOURCE_NAME)/doc
	install -m 644 doc/cmdrefcard.tex       $(SOURCE_NAME)/doc
	install -m 644 doc/refcard.tex          $(SOURCE_NAME)/doc
	install -m 644 doc/Makefile             $(SOURCE_NAME)/doc
	install -m 644 doc/FAQ.html             $(SOURCE_NAME)/doc
	install -m 644 doc/gri-manpage*.1       $(SOURCE_NAME)/doc
	install -m 644 doc/gri_merge.1          $(SOURCE_NAME)/doc
	install -m 644 doc/gri_unpage.1         $(SOURCE_NAME)/doc
	install -m 644 doc/gri.texim            $(SOURCE_NAME)/doc
	install -m 755 doc/gri2texi             $(SOURCE_NAME)/doc
	install -m 755 doc/texinfo2HTML         $(SOURCE_NAME)/doc
	install -m 755 doc/gri2html             $(SOURCE_NAME)/doc
	install -m 755 doc/HTML_subdivide       $(SOURCE_NAME)/doc
	install -m 644 doc/make_html_index      $(SOURCE_NAME)/doc
	install -m 644 doc/make_html_commandindex $(SOURCE_NAME)/doc
	install -m 644 doc/make_html_builtinindex $(SOURCE_NAME)/doc
	install -d $(SOURCE_NAME)/doc/resources
	install -m 644 doc/resources/*.gri doc/resources/*.gif \
		$(SOURCE_NAME)/doc/resources
	install -d $(SOURCE_NAME)/doc/examples
	install -m 644 doc/examples/*.gri          $(SOURCE_NAME)/doc/examples
	install -m 644 doc/examples/*.txt          $(SOURCE_NAME)/doc/examples
	install -m 644 doc/examples/*.dat          $(SOURCE_NAME)/doc/examples
	install -m 644 doc/examples/*.ps           $(SOURCE_NAME)/doc/examples
	install -m 755 doc/examples/FEM.pl         $(SOURCE_NAME)/doc/examples
	install -m 644 doc/examples/model.elements $(SOURCE_NAME)/doc/examples
	install -m 644 doc/examples/model.nodes    $(SOURCE_NAME)/doc/examples
	install -m 644 doc/examples/Makefile       $(SOURCE_NAME)/doc/examples
	install -d $(SOURCE_NAME)/doc/screenshots
	(cd doc/screenshots/; \
	    install -m 644 Makefile *.png ../../$(SOURCE_NAME)/doc/screenshots)
	install -d $(SOURCE_NAME)/doc/tst_suite
	install -m 644 doc/tst_suite/Makefile        $(SOURCE_NAME)/doc/tst_suite
	install -m 644 doc/tst_suite/tst_IO.gri      $(SOURCE_NAME)/doc/tst_suite
	install -m 644 doc/tst_suite/tst_IO_1.dat    $(SOURCE_NAME)/doc/tst_suite
	install -m 644 doc/tst_suite/tst_IO_2.dat    $(SOURCE_NAME)/doc/tst_suite
	install -m 644 doc/tst_suite/tst_control.gri $(SOURCE_NAME)/doc/tst_suite
	install -m 644 doc/tst_suite/tst_rpn.gri     $(SOURCE_NAME)/doc/tst_suite
	install -m 644 doc/tst_suite/tst_var_syn.gri $(SOURCE_NAME)/doc/tst_suite

source: source-copy
#
#	Tar package, compress it, install it.
	tar -c -f $(SOURCE_NAME).tar $(SOURCE_NAME)
	rm -rf $(SOURCE_NAME)
	gzip -f --best $(SOURCE_NAME).tar
	mv $(SOURCE_NAME).tar.gz $(DEST_DIR)/$(SOURCE_NAME).tgz
	chmod a+r $(DEST_DIR)/$(SOURCE_NAME).tgz

source-arch-indep: source-copy
	cd $(SOURCE_NAME)/doc; make refcard.ps cmdrefcard.ps info html
	tar -c -f $(SOURCE_NAME)-arch-indep.tar $(SOURCE_NAME)
	rm -rf $(SOURCE_NAME)
	gzip -f --best $(SOURCE_NAME)-arch-indep.tar
	-mv $(SOURCE_NAME)-arch-indep.tar.gz $(DEST_DIR)/
	chmod a+r $(DEST_DIR)/$(SOURCE_NAME)-arch-indep.tar.gz


README-ftp:
	lynx -dump README-ftp.html > README-ftp
	chmod a+r README-ftp

check:
	@perl ./check.pl

# Probably 'test' and 'test-installed' could be combined in some elegant fashion,
# and that would be good since it would prevent them becoming different ... for 
# now, just remember to edit both together!!
test:
	@./gri -directory . -c 0 doc/tst_suite/tst_var_syn.gri 
	@./gri -directory . -c 0 doc/tst_suite/tst_control.gri
	@./gri -directory . -c 0 doc/tst_suite/tst_rpn.gri
	@cd doc/tst_suite ; ../../gri -directory ../.. -c 0 tst_IO.gri
	@cat version.cc    | perl -ane 'if(/_number/)             {$$v=$$F[3]; $$v=~s/[^"]*"//; $$v=~s/".*//; die "ERROR: version number in version.cc is $$v, which disagrees with the version in the Makefile, $(VERSION).  You MUST fix this.\n" if ("$$v" ne "$(VERSION)"); print "Version number in version.cc       ... is OK\n";}'
	@cat gri.cmd       | perl -ane 'if(/\(version ([^)]*)\)/) {$$v=$$1; die "ERROR: Version in gri.cmd is $$v, which disagrees with the version in the Makefile, $(VERSION).  You MUST fix this.\n" if ("$$v" ne "$(VERSION)"); print "Version number in gri.cmd          ... is OK\n";}'
	@cat doc/gri.texim | perl -ane 'if(/GRI-VERSION (.*)/)    {$$v=$$1; die "ERROR: Version in doc/gri.texim is $$v, which disagrees with the version in the Makefile, $(VERSION).  You MUST fix this.\n" if ("$$v" ne "$(VERSION)"); print "Version number in doc/gri.texim    ... is OK\n";}'
	@cat gri.spec      | perl -ane 'if(/griversion (.*)/)     {$$v=$$1; if ("$$v" ne "$(VERSION)") {warn "ERROR: Version in gri.spec is $$v, which disagrees with the version in the Makefile, $(VERSION).  You SHOULD fix this.\n"} else { print "Version number in gri.spec         ... is OK\n";}}'
	@cat debian/changelog | perl -ne 'if (($$. == 1)&&(/\(([^-]+)-/)) {if ("$$1" ne "$(VERSION)") {print "**WARNING: Version in debian/changelog is $$1,\n** which disagrees with the version in the Makefile, $(VERSION).\n** You should fix this for official releases.\n"} else { print "Version number in debian/changelog ... is OK\n";}}'
	@echo ""
	@echo "    /----------------------------------------------\\"
	@echo "    | NOTE: Developers should do 'make check' next |"
	@echo "    \\----------------------------------------------/"
	@echo ""

test-installed:
	@gri -c0 doc/tst_suite/tst_var_syn.gri 
	@gri -c0 doc/tst_suite/tst_control.gri
	@gri -c0 doc/tst_suite/tst_rpn.gri
	@cd doc/tst_suite ; gri -c0 tst_IO.gri

what_is_new:
	@for f in gri*.spec gri.cmd logo.dat *cc *hh Makefile.in configure.in doc/gri.texi doc/Makefile;\
		do diff --brief $$f ../$$f;\
	done

# Sun microsystems, sunOS 5.x
# NOTE: this target doesn't depend on 'gri' or 'doc', etc; this
# is to be done manually, the first step perhaps on an 
# entirely different computer!!
        SUNOS5_NAME = gri-$(VERSION)-SunOS5
package-SunOS5:
	-rm -rf          $(SUNOS5_NAME)
	-mkdir -m 755 -p $(SUNOS5_NAME)
	-mkdir -m 755 -p $(SUNOS5_NAME)/bin
	-mkdir -m 755 -p $(SUNOS5_NAME)/lib
	-mkdir -m 755 -p $(SUNOS5_NAME)/doc
	-mkdir -m 755 -p $(SUNOS5_NAME)/doc/html
	-mkdir -m 755 -p $(SUNOS5_NAME)/doc/html/resources
	-mkdir -m 755 -p $(SUNOS5_NAME)/doc/html/screenshots
	-mkdir -m 755 -p $(SUNOS5_NAME)/doc/html/tst_suite
	-mkdir -m 755 -p $(SUNOS5_NAME)/doc/html/examples
	-cp -p gri                                                        $(SUNOS5_NAME)/bin
	-cp  gri.cmd logo.dat copyright.txt license.txt gri-mode.el       $(SUNOS5_NAME)/lib
	-cat startup.msg | sed -e s,VSN,${VERSION}, | sed -e "s/DATE/`date`/" > tmp
	-cp tmp                                                           $(SUNOS5_NAME)/lib/startup.msg
	-cat install-SunOS5 | sed -e s,VSN,${VERSION}, > tmp
	-cp tmp                                                           $(SUNOS5_NAME)/install
	-chmod a+rx                                                       $(SUNOS5_NAME)/install
	-cp README-SunOS5                                                 $(SUNOS5_NAME)/README
	-cat doc/gri-manpage-SunOS5.1 | sed -e s,VERSION,${VERSION}, >tmp
	-cp tmp                                                           $(SUNOS5_NAME)/doc/gri.1
	-rm -f tmp
#       Next should really be done by "cd doc; make something" etc.
	-cp doc/*html                                                     $(SUNOS5_NAME)/doc/html
	-cp doc/*png                                                      $(SUNOS5_NAME)/doc/html
	-cp doc/resources/*gif                                            $(SUNOS5_NAME)/doc/html/resources
	-cp doc/screenshots/*png                                          $(SUNOS5_NAME)/doc/html/screenshots
	-cp doc/tst_suite/*dat doc/tst_suite/*gri doc/tst_suite/*html     $(SUNOS5_NAME)/doc/html/tst_suite
	-cp doc/examples/*dat doc/examples/*gri doc/examples/*html        $(SUNOS5_NAME)/doc/html/examples
	-tar chof $(SUNOS5_NAME).tar $(SUNOS5_NAME)
	-rm -rf $(SUNOS5_NAME)
	-gzip $(SUNOS5_NAME).tar
